# 🚴‍♂️ 最終実装クリーンアップ計画

## 1. 概要
現状のプロトタイプ実装を、本番運用を見据えた品質に引き上げるためのクリーンアップ計画です。ハードコーディングの解消、エラーハンドリングの強化、テスト拡充、およびUI/UXの改善を行います。

## 2. 現状の課題と改善点

### 2.1 バックエンド (C++ / Drogon)
- **ハードコーディング**:
  - `SpotService.cc`: スポット検索の半径がデフォルト値（1000.0）またはハードコードされたロジックに依存している箇所がある。API呼び出しパラメータの一部が固定値。
  - `RouteService.cc`: 地球半径や計算定数などがローカル定数として定義されている（これは許容範囲だが、設定化できるとなお良い）。
- **ダミーデータ**:
  - 特になし（実際のOSRM/Google Places APIを使用）。ただし、デバッグ用のコメントアウトされたコードが残存。
- **エラーハンドリング**:
  - OSRMやGoogle APIのエラー時に、より詳細なログ出力やクライアントへの適切なエラーメッセージ返却が必要。
  - 外部API呼び出しのタイムアウト処理は実装されているが、リトライロジックがない。
- **テスト**:
  - 主要なサービスクラスの単体テストは存在するが、エッジケース（API障害時など）のカバレッジを向上させる必要がある。

### 2.2 フロントエンド (Next.js)
- **ハードコーディング**:
  - `page.tsx`: Google Maps APIキーが環境変数から取得されているが、フォールバック値が空文字になっている。
  - デフォルトの緯度経度（名古屋駅）がハードコードされている。設定ファイルや定数ファイルに切り出すべき。
- **UI/UX**:
  - エラー表示がテキストのみでユーザーに優しくない。
  - ローディング状態の表示がシンプルすぎる。
- **コンポーネント**:
  - `WaypointsList` などのコンポーネントが `page.tsx` と密結合している部分がある。

## 3. 作業タスク詳細

### Phase 1: バックエンドの改善
- [ ] **ConfigServiceの拡充**:
  - API呼び出しのタイムアウト値、リトライ回数、デフォルト検索半径などを環境変数または設定ファイルから読み込めるようにする。
- [ ] **SpotServiceの強化**:
  - Google Places APIのエラーハンドリング強化（クォータ制限、不正なレスポンスなど）。
  - 検索半径やタイプをリクエストパラメータから柔軟に受け取れるように改修。
- [ ] **コードクリーンアップ**:
  - 不要なコメントアウト、デバッグログの整理。
  - `using namespace` の使用を見直し、名前空間の汚染を防ぐ。

### Phase 2: フロントエンドの改善
- [ ] **定数管理**:
  - デフォルト座標、APIエンドポイント、マップ設定などを `src/config/constants.ts` 等に集約。
- [ ] **エラーハンドリングとUI改善**:
  - トースト通知（例: `react-hot-toast`）の導入によるユーザーフィードバックの向上。
  - APIエラー時の具体的なメッセージ表示。
- [ ] **コンポーネントのリファクタリング**:
  - `page.tsx` の巨大化を防ぐため、ロジック（カスタムフック化）と表示を分離。

### Phase 3: テストと検証
- [ ] **バックエンドテスト拡充**:
  - `SpotService` のモックを使用したテストケース追加（外部APIに依存しないテスト）。
  - 異常系（ネットワークエラー、不正な入力）のテスト追加。
- [ ] **フロントエンドテスト拡充**:
  - `UserEvent` を使用したより実践的なインタラクションテスト。
  - エラー状態の表示テスト。

### Phase 4: ドキュメントとデプロイ準備
- [ ] **READMEの更新**:
  - 最新のセットアップ手順、環境変数の説明を追加。
- [ ] **Docker構成の確認**:
  - 本番用ビルド設定（マルチステージビルドの最適化など）の確認。

## 4. 実行手順

1. **バックエンド改修** (Phase 1)
2. **バックエンドテスト追加** (Phase 3-1)
3. **フロントエンドリファクタリング** (Phase 2)
4. **フロントエンドテスト追加** (Phase 3-2)
5. **最終動作確認**

## 5. 推定スケジュール（目安）
- Phase 1: 1-2日
- Phase 2: 1-2日
- Phase 3: 1日
- Phase 4: 0.5日

name: CI

on:
  pull_request:
    branches: [ "**" ]

jobs:
  # Frontend Jobs
  frontend-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check Formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

  # Backend Jobs
  backend-test:
    runs-on: ubuntu-22.04
    services:
      redis:
        image: redis
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4

      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib
            /usr/local/include
            /usr/local/bin
            /usr/local/share/osrm
          key: ${{ runner.os }}-backend-deps-v3

      - name: Install dependencies (apt)
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake clang-tidy \
            libjsoncpp-dev uuid-dev zlib1g-dev libssl-dev libhiredis-dev \
            libboost-all-dev libtbb-dev liblua5.3-dev libluabind-dev libstxxl-dev \
            libxml2-dev libosmpbf-dev libbz2-dev libzip-dev libprotobuf-dev \
            protobuf-compiler pkg-config

      - name: Install OSRM Backend
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/Project-OSRM/osrm-backend.git
          cd osrm-backend
          git checkout v5.27.1
          mkdir build
          cd build
          cmake .. -DENABLE_MASON=OFF -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          sudo make install
          cd ../..
          rm -rf osrm-backend

      - name: Install Drogon
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/drogonframework/drogon
          cd drogon
          git checkout v1.9.5
          git submodule update --init
          mkdir build
          cd build
          # hiredis の場所を明示しつつ、Drogon が Redis を見つけられるように強制する
          cmake .. -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_EXAMPLES=OFF \
            -DENABLE_REDIS=ON \
            -DHiredis_INCLUDE_DIR=/usr/include/hiredis \
            -DHiredis_LIBRARIES=/usr/lib/x86_64-linux-gnu/libhiredis.so
          make -j$(nproc)
          sudo make install
          cd ../..
          rm -rf drogon

      - name: Configure CMake (Test Only)
        run: |
          rm -rf build
          cmake -S . -B build -DBUILD_TESTS_ONLY=ON -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Test
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          cd build
          ctest --output-on-failure

  backend-format:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Check Formatting
        run: |
          # Check backend source files
          find backend -type f \( -name "*.cc" -o -name "*.h" \) -not -path "*/build/*" | xargs clang-format --dry-run --Werror -style=file:.clang-format

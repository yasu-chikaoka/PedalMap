name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  # Frontend Jobs
  frontend-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check Formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

  # Backend Jobs
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4

      - name: Install CMake, GTest & Clang-Tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libgtest-dev clang-tidy

      - name: Configure CMake (Test Only)
        run: cmake -S . -B build -DBUILD_TESTS_ONLY=ON -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Lint (Clang-Tidy)
        run: |
          # Run clang-tidy on source files
          # Using find to get .cc files, avoiding build directory
          find . -name "*.cc" -not -path "./build/*" | xargs clang-tidy -p build --quiet --config-file=../.clang-tidy

      - name: Build
        run: cmake --build build

      - name: Test
        run: |
          cd build
          ctest --output-on-failure

  backend-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get install -y clang-format

      - name: Check Formatting
        run: |
          # Check backend source files
          find backend -type f \( -name "*.cc" -o -name "*.h" \) -not -path "*/build/*" | xargs clang-format --dry-run --Werror -style=file:.clang-format